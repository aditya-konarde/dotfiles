#!/bin/bash
#
# Gitleaks Pre-commit Hook
# Scans staged changes for secrets before allowing commits
#
# Installation:
#   cp .config/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or configure git to use this directory:
#   git config core.hooksPath .config/git-hooks
#

# Find gitleaks - check common locations
GITLEAKS=""
if command -v gitleaks &> /dev/null; then
    GITLEAKS="gitleaks"
elif [ -f "/c/Users/$USER/AppData/Local/Microsoft/WinGet/Packages/Gitleaks.Gitleaks_Microsoft.Winget.Source_8wekyb3d8bbwe/gitleaks.exe" ]; then
    GITLEAKS="/c/Users/$USER/AppData/Local/Microsoft/WinGet/Packages/Gitleaks.Gitleaks_Microsoft.Winget.Source_8wekyb3d8bbwe/gitleaks.exe"
elif [ -f "$HOME/AppData/Local/Microsoft/WinGet/Packages/Gitleaks.Gitleaks_Microsoft.Winget.Source_8wekyb3d8bbwe/gitleaks.exe" ]; then
    GITLEAKS="$HOME/AppData/Local/Microsoft/WinGet/Packages/Gitleaks.Gitleaks_Microsoft.Winget.Source_8wekyb3d8bbwe/gitleaks.exe"
fi

# ENFORCE - block commit if gitleaks not found
if [ -z "$GITLEAKS" ]; then
    echo "ERROR: gitleaks is not installed."
    echo ""
    echo "Install with:"
    echo "  macOS:   brew install gitleaks"
    echo "  Windows: winget install Gitleaks.Gitleaks"
    echo "  Linux:   https://github.com/gitleaks/gitleaks#installing"
    echo ""
    echo "Commit blocked. Install gitleaks to proceed."
    exit 1
fi

# Run gitleaks on staged changes
echo "Running gitleaks secret scan..."

# Use protect mode to scan staged changes
"$GITLEAKS" protect --staged --verbose --redact

exit_code=$?

if [ $exit_code -eq 0 ]; then
    echo "No secrets detected."
else
    echo ""
    echo "ERROR: Secrets detected in staged changes!"
    echo "Please remove the secrets before committing."
    echo ""
    echo "If this is a false positive, you can:"
    echo "  1. Add to .gitleaksignore file"
    echo "  2. Use --no-verify flag (NOT recommended)"
    exit 1
fi
